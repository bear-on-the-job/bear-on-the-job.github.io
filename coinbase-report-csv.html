  
<html>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const csvInput = 
        `portfolio,trade id,product,side,created at,size,size unit,price,fee,total,price/fee/total unit
        default,6220,SOL-USD,BUY,2021-06-17T22:22:51.668Z,0.26000000,SOL,38.793,0.0504309,-10.1366109,USD
        default,33904,SOL-USD,BUY,2021-06-18T19:43:40.416Z,0.13800000,SOL,35.838,0.02472822,-4.97037222,USD
        default,67118,SOL-USD,BUY,2021-06-20T12:37:26.508Z,0.15300000,SOL,32.377,0.024768405,-4.978449405,USD
        default,75905,DOT-USD,BUY,2021-06-18T14:24:52.232Z,0.23300000,DOT,21.276,0.02478654,-4.98209454,USD
        default,140956,DOT-USD,BUY,2021-06-19T21:07:13.302Z,0.23800000,DOT,20.874,0.02484006,-4.99285206,USD`;
  const csv = `${csvInput}`;
  
  //var csv is the CSV file with headers
  function csvToArray(csv){
    var lines=csv.split("\n");
    var result = [];
    var headers=lines[0].split(",");

    for(var i=1;i<lines.length;i++){
      var obj = {};
      var currentline=lines[i].split(",");
      for(var j=0;j<headers.length;j++){
        obj[headers[j]] = currentline[j];
      }
      result.push(obj);
    }
    
    return result;
    //return JSON.stringify(result);
  }
  
  function transformFills(fills) {
    var result = {};
    for(var fill of fills) {
      var product = result[fill["size unit"]] ??= {
        "total-amount": 0.0,
        "total-cost": 0.0,
        "average-cost": 0.0,
      };
      
      product["total-amount"] += parseFloat(fill["size"]);
      product["total-cost"] += (parseFloat(fill["size"]) * parseFloat(fill["price"]));
      product["average-cost"] = product["total-cost"] / product["total-amount"];      
    }
    
    return result;
  }
  
  var fills = csvToArray(csv);
  var transformed = transformFills(fills);
  document.write(JSON.stringify(transformed));  
  
  /*
  B=SUM(SUMIF(Coinbase!$G$2:$G, A2, Coinbase!$F$2:$F), SUMIF(AnchorUSD!$G$2:$G, A2, AnchorUSD!$F$2:$F), SUMIF(FixedFloat!$E$2:$E, A2, FixedFloat!$F$2:$F), SUMIF(FixedFloat!$I$2:$I, A2, FixedFloat!$J$2:$J))
  G=SUM(SUMPRODUCT(Coinbase!$F$2:$F, Coinbase!$H$2:$H*(Coinbase!$G$2:$G=A2)*(Coinbase!$D$2:$D="BUY")),SUMPRODUCT(AnchorUSD!$F$2:$F, AnchorUSD!$H$2:$H*(AnchorUSD!$G$2:$G=A2)*(AnchorUSD!$D$2:$D="BUY")),SUMPRODUCT(FixedFloat!$F$2:$F, FixedFloat!$G$2:$G*(FixedFloat!$E$2:$E=A2)),-SUMPRODUCT(FixedFloat!$F$2:$F, FixedFloat!$G$2:$G*(FixedFloat!$I$2:$I=A2)))
  AVG==IF(B>0, G/B, 0)
  */
  
</script>
</html>

